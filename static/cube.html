<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube</title>
    <link rel="stylesheet" href="cube.css">
    <!-- Required for Go's WebAssembly runtime -->
    <script src="wasm_exec.js"></script>
    <!-- Three.js library for 3D rendering -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <h1>Rubik's Cube</h1>
    
    <div id="container">
        <div id="cubeCanvas"></div>
        
        <div class="controls">
            <div class="face-controls">
                <div class="face-label">Front Face (White)</div>
                <button onclick="handleRotate(0, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(0, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <div class="face-controls">
                <div class="face-label">Back Face (Yellow)</div>
                <button onclick="handleRotate(1, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(1, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <div class="face-controls">
                <div class="face-label">Up Face (Blue)</div>
                <button onclick="handleRotate(2, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(2, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <div class="face-controls">
                <div class="face-label">Down Face (Green)</div>
                <button onclick="handleRotate(3, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(3, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <div class="face-controls">
                <div class="face-label">Left Face (Red)</div>
                <button onclick="handleRotate(4, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(4, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <div class="face-controls">
                <div class="face-label">Right Face (Orange)</div>
                <button onclick="handleRotate(5, true)">Rotate Clockwise</button>
                <button onclick="handleRotate(5, false)">Rotate Counter-Clockwise</button>
            </div>
            
            <button class="reset" onclick="handleReset()">Reset Cube</button>
        </div>
    </div>
    
    <script>
        // Global flag to track WebAssembly loading status
        let wasmLoaded = false;
        
        // Color mapping from Color enum (integer) to hex color
        const colorEnumToHex = {
            0: 0xFFFFFF, // White
            1: 0xFFFF00, // Yellow
            2: 0x0000FF, // Blue
            3: 0x00FF00, // Green
            4: 0xFF0000, // Red
            5: 0xFFA500  // Orange
        };
        
        // Color mapping from Color enum (integer) to color name 
        const colorEnumToName = {
            0: "white",  // White
            1: "yellow", // Yellow
            2: "blue",   // Blue
            3: "green",  // Green
            4: "red",    // Red
            5: "orange"  // Orange
        };
        
        // Simple JS bridge to Go WASM functions
        function handleRotate(face, clockwise) {
            if (!wasmLoaded) {
                console.warn("WebAssembly not loaded yet");
                return;
            }
            
            console.log(`Rotating face ${face} ${clockwise ? "clockwise" : "counter-clockwise"}`);
            try {
                wasmRotateFace(face, clockwise);
            } catch (e) {
                console.error("Error calling wasmRotateFace:", e);
            }
        }
        
        function handleReset() {
            if (!wasmLoaded) {
                console.warn("WebAssembly not loaded yet");
                return;
            }
            
            console.log("Resetting cube");
            try {
                wasmResetCube();
            } catch (e) {
                console.error("Error calling wasmResetCube:", e);
            }
        }
        
        // Debug logging for WebAssembly global scope
        function debugGlobalScope() {
            console.log("Global scope keys:", Object.keys(window).filter(key => key.startsWith("wasm")));
        }
        
        // Initialize Three.js with JavaScript if WebAssembly setup fails
        function initThreeFallback() {
            console.warn("Using JavaScript fallback for Three.js initialization");
            
            // ThreeJS variables
            let scene, camera, renderer, controls;
            let cubeGroup;
            const cubeSize = 1;
            const gap = 0.05;
            
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, 600 / 500, 0.1, 1000);
            camera.position.set(4, 4, 4);
            camera.lookAt(0, 0, 0);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(600, 500);
            document.getElementById('cubeCanvas').appendChild(renderer.domElement);
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(10, 20, 30);
            scene.add(directionalLight);
            
            // Create cube group
            cubeGroup = new THREE.Group();
            scene.add(cubeGroup);
            
            // Start animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            
            animate();
            
            // Fetch initial state
            fetch('/api/state')
                .then(response => response.json())
                .then(data => {
                    console.log("Loaded cube state from API");
                })
                .catch(error => console.error('Error fetching cube state:', error));
        }
        
        // Load the WebAssembly module with better error handling
        async function loadWasm() {
            try {
                console.log("Attempting to load WebAssembly module...");
                const go = new Go();
                
                // Try to fetch the module
                const result = await WebAssembly.instantiateStreaming(
                    fetch("main.wasm"),
                    go.importObject
                );
                
                // Run the instance
                console.log("WebAssembly fetched, running instance...");
                go.run(result.instance);
                
                // Check if the functions are registered
                setTimeout(() => {
                    console.log("Checking for WASM functions...");
                    debugGlobalScope();
                    
                    // Try to initialize Three.js through WebAssembly
                    if (typeof wasmInitThreeScene === 'function') {
                        console.log("Calling wasmInitThreeScene...");
                        wasmInitThreeScene();
                        wasmLoaded = true;
                    } else {
                        console.error("wasmInitThreeScene function not found");
                        initThreeFallback();
                    }
                }, 500);
                
            } catch (err) {
                console.error("Failed to load WebAssembly:", err);
                initThreeFallback();
            }
        }
        
        // Start loading when the page is ready
        document.addEventListener('DOMContentLoaded', loadWasm);
    </script>
</body>
</html>